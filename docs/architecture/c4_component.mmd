%%{init: {'theme':'base', 'themeVariables': { 'primaryColor': '#ff0000'}}}%%
%% C4 Component Diagram - Backend Services Detail
%% Created: 2025-01-19
%% Shows the components within the backend container

flowchart TB
    %% External
    MobileApp["ğŸ“± Flutter Mobile App"]
    Firebase["ğŸ” Firebase Auth"]
    MongoDB["ğŸ—„ï¸ MongoDB"]
    FileStorage["ğŸ“ File Storage"]
    
    %% Backend Container Boundary
    subgraph BackendContainer ["Express.js Backend Container"]
        %% Entry Point
        Server["ğŸš€ Server.js<br/>Application Entry Point"]
        
        %% Middleware Components
        subgraph MiddlewareLayer ["Middleware Layer"]
            AuthMW["ğŸ” Auth Middleware<br/>JWT validation"]
            CORSMW["ğŸŒ CORS Middleware<br/>Cross-origin requests"]
            LogMW["ğŸ“ Logging Middleware<br/>Request/response logging"]
            ErrorMW["âŒ Error Handler<br/>Global error handling"]
        end
        
        %% Route Components
        subgraph RouteLayer ["Route Layer"]
            AuthRoutes["ğŸ”‘ Auth Routes<br/>/api/auth/*"]
            UserRoutes["ğŸ‘¤ User Routes<br/>/api/users/*"]
            ClientRoutes["ğŸ‘¥ Client Routes<br/>/api/clients/*"]
            AppointmentRoutes["ğŸ“… Appointment Routes<br/>/api/appointments/*"]
            ExpenseRoutes["ğŸ’° Expense Routes<br/>/api/expenses/*"]
            InvoiceRoutes["ğŸ“„ Invoice Routes<br/>/api/invoices/*"]
            TrackingRoutes["â±ï¸ Tracking Routes<br/>/api/tracking/*"]
            PricingRoutes["ğŸ’² Pricing Routes<br/>/api/pricing/*"]
        end
        
        %% Controller Components
        subgraph ControllerLayer ["Controller Layer"]
            AuthController["ğŸ”‘ Auth Controller<br/>Login, registration"]
            UserController["ğŸ‘¤ User Controller<br/>User management"]
            ClientController["ğŸ‘¥ Client Controller<br/>Client operations"]
            AppointmentController["ğŸ“… Appointment Controller<br/>Appointment management"]
            ExpenseController["ğŸ’° Expense Controller<br/>Expense processing"]
            InvoiceController["ğŸ“„ Invoice Controller<br/>Invoice generation"]
            TrackingController["â±ï¸ Tracking Controller<br/>Time tracking"]
            PricingController["ğŸ’² Pricing Controller<br/>Price management"]
        end
        
        %% Service Components
        subgraph ServiceLayer ["Service Layer"]
            AuthService["ğŸ”‘ Auth Service<br/>Authentication logic"]
            UserService["ğŸ‘¤ User Service<br/>User business logic"]
            ClientService["ğŸ‘¥ Client Service<br/>Client business logic"]
            AppointmentService["ğŸ“… Appointment Service<br/>Appointment logic"]
            ExpenseService["ğŸ’° Expense Service<br/>Expense logic"]
            InvoiceService["ğŸ“„ Invoice Service<br/>Invoice generation"]
            TrackingService["â±ï¸ Tracking Service<br/>Time tracking logic"]
            PricingService["ğŸ’² Pricing Service<br/>Pricing calculations"]
            AuditService["ğŸ“‹ Audit Service<br/>Audit trail logging"]
        end
        
        %% Utility Components
        subgraph UtilityLayer ["Utility Layer"]
            CryptoUtils["ğŸ”’ Crypto Helpers<br/>Encryption/hashing"]
            DateUtils["ğŸ“… Date Helpers<br/>Date calculations"]
            FileUtils["ğŸ“ File Helpers<br/>File operations"]
            ValidationUtils["âœ… Validation Helpers<br/>Input validation"]
            PricingUtils["ğŸ’² Pricing Helpers<br/>Price calculations"]
        end
        
        %% Configuration
        subgraph ConfigLayer ["Configuration Layer"]
            DBConfig["ğŸ—„ï¸ Database Config<br/>MongoDB connection"]
            FirebaseConfig["ğŸ” Firebase Config<br/>Auth configuration"]
            MulterConfig["ğŸ“¤ Multer Config<br/>File upload settings"]
        end
    end
    
    %% Relationships
    MobileApp -->|"HTTP Requests"| Server
    
    Server --> MiddlewareLayer
    MiddlewareLayer --> RouteLayer
    RouteLayer --> ControllerLayer
    ControllerLayer --> ServiceLayer
    ServiceLayer --> UtilityLayer
    
    %% External connections
    AuthMW -->|"Token Validation"| Firebase
    ServiceLayer -->|"Data Operations"| MongoDB
    FileUtils -->|"File Operations"| FileStorage
    
    %% Configuration usage
    ServiceLayer --> ConfigLayer
    MiddlewareLayer --> ConfigLayer
    
    %% Specific route to controller mappings
    AuthRoutes --> AuthController
    UserRoutes --> UserController
    ClientRoutes --> ClientController
    AppointmentRoutes --> AppointmentController
    ExpenseRoutes --> ExpenseController
    InvoiceRoutes --> InvoiceController
    TrackingRoutes --> TrackingController
    PricingRoutes --> PricingController
    
    %% Controller to service mappings
    AuthController --> AuthService
    UserController --> UserService
    ClientController --> ClientService
    AppointmentController --> AppointmentService
    ExpenseController --> ExpenseService
    InvoiceController --> InvoiceService
    TrackingController --> TrackingService
    PricingController --> PricingService
    
    %% Cross-cutting concerns
    ServiceLayer --> AuditService
    
    %% Styling
    classDef external fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef entry fill:#e3f2fd,stroke:#0277bd,stroke-width:2px
    classDef middleware fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef route fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef controller fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef service fill:#fff8e1,stroke:#f9a825,stroke-width:2px
    classDef utility fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef config fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    
    class MobileApp,Firebase,MongoDB,FileStorage external
    class Server entry
    class AuthMW,CORSMW,LogMW,ErrorMW middleware
    class AuthRoutes,UserRoutes,ClientRoutes,AppointmentRoutes,ExpenseRoutes,InvoiceRoutes,TrackingRoutes,PricingRoutes route
    class AuthController,UserController,ClientController,AppointmentController,ExpenseController,InvoiceController,TrackingController,PricingController controller
    class AuthService,UserService,ClientService,AppointmentService,ExpenseService,InvoiceService,TrackingService,PricingService,AuditService service
    class CryptoUtils,DateUtils,FileUtils,ValidationUtils,PricingUtils utility
    class DBConfig,FirebaseConfig,MulterConfig config