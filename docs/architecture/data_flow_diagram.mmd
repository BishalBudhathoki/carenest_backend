%%{init: {'theme':'base', 'themeVariables': { 'primaryColor': '#ff0000'}}}%%
%% Data Flow Diagram - Invoice Management System
%% Created: 2025-01-19
%% Shows how data flows through the system

flowchart TD
    %% External Data Sources
    UserInput["ğŸ‘¤ User Input<br/>Mobile App"]
    NDISData["ğŸ“‹ NDIS Database<br/>Support Items & Pricing"]
    FileUploads["ğŸ“¤ File Uploads<br/>Expense Photos"]
    
    %% Input Processing
    subgraph InputLayer ["Input Processing Layer"]
        AuthValidation["ğŸ” Authentication<br/>Validation"]
        InputValidation["âœ… Input Validation<br/>& Sanitization"]
        FileProcessing["ğŸ“ File Processing<br/>& Storage"]
    end
    
    %% Core Processing
    subgraph CoreProcessing ["Core Business Processing"]
        UserMgmt["ğŸ‘¤ User Management<br/>Registration, Profile"]
        ClientMgmt["ğŸ‘¥ Client Management<br/>Assignments, Profiles"]
        TimeMgmt["â±ï¸ Time Management<br/>Tracking, Timers"]
        ExpenseMgmt["ğŸ’° Expense Management<br/>Recording, Validation"]
        PricingEngine["ğŸ’² Pricing Engine<br/>Calculations, Validation"]
        InvoiceEngine["ğŸ“„ Invoice Engine<br/>Generation, Processing"]
        AuditEngine["ğŸ“‹ Audit Engine<br/>Trail Logging"]
    end
    
    %% Data Storage
    subgraph DataStorage ["Data Storage Layer"]
        UserData["ğŸ‘¤ User Data<br/>MongoDB Collection"]
        ClientData["ğŸ‘¥ Client Data<br/>MongoDB Collection"]
        TimeData["â±ï¸ Time Tracking<br/>MongoDB Collection"]
        ExpenseData["ğŸ’° Expense Data<br/>MongoDB Collection"]
        InvoiceData["ğŸ“„ Invoice Data<br/>MongoDB Collection"]
        PricingData["ğŸ’² Pricing Data<br/>MongoDB Collection"]
        AuditData["ğŸ“‹ Audit Trail<br/>MongoDB Collection"]
        FileData["ğŸ“ File Storage<br/>Local/Cloud Storage"]
    end
    
    %% Output Processing
    subgraph OutputLayer ["Output Processing Layer"]
        ResponseFormatting["ğŸ“‹ Response Formatting<br/>JSON Serialization"]
        PDFGeneration["ğŸ“„ PDF Generation<br/>Invoice Documents"]
        NotificationSvc["ğŸ”” Notification Service<br/>Push Notifications"]
        ReportGeneration["ğŸ“Š Report Generation<br/>Analytics & Summaries"]
    end
    
    %% External Outputs
    APIResponse["ğŸ“± API Response<br/>Mobile App"]
    GeneratedPDFs["ğŸ“„ Generated PDFs<br/>Invoice Documents"]
    Notifications["ğŸ”” Push Notifications<br/>Mobile Devices"]
    Reports["ğŸ“Š Reports & Analytics<br/>Dashboard Data"]
    
    %% Data Flow Connections
    
    %% Input flows
    UserInput --> AuthValidation
    UserInput --> InputValidation
    FileUploads --> FileProcessing
    NDISData --> PricingEngine
    
    %% Processing flows
    AuthValidation --> UserMgmt
    InputValidation --> ClientMgmt
    InputValidation --> TimeMgmt
    InputValidation --> ExpenseMgmt
    FileProcessing --> ExpenseMgmt
    
    %% Cross-processing flows
    UserMgmt --> ClientMgmt
    ClientMgmt --> TimeMgmt
    TimeMgmt --> PricingEngine
    ExpenseMgmt --> PricingEngine
    PricingEngine --> InvoiceEngine
    
    %% Audit flows
    UserMgmt --> AuditEngine
    ClientMgmt --> AuditEngine
    TimeMgmt --> AuditEngine
    ExpenseMgmt --> AuditEngine
    InvoiceEngine --> AuditEngine
    
    %% Storage flows
    UserMgmt --> UserData
    ClientMgmt --> ClientData
    TimeMgmt --> TimeData
    ExpenseMgmt --> ExpenseData
    InvoiceEngine --> InvoiceData
    PricingEngine --> PricingData
    AuditEngine --> AuditData
    FileProcessing --> FileData
    
    %% Output flows
    UserData --> ResponseFormatting
    ClientData --> ResponseFormatting
    TimeData --> ResponseFormatting
    ExpenseData --> ResponseFormatting
    InvoiceData --> ResponseFormatting
    PricingData --> ResponseFormatting
    
    InvoiceData --> PDFGeneration
    TimeData --> NotificationSvc
    ExpenseData --> NotificationSvc
    
    UserData --> ReportGeneration
    TimeData --> ReportGeneration
    ExpenseData --> ReportGeneration
    InvoiceData --> ReportGeneration
    
    %% Final outputs
    ResponseFormatting --> APIResponse
    PDFGeneration --> GeneratedPDFs
    NotificationSvc --> Notifications
    ReportGeneration --> Reports
    
    %% Feedback loops
    APIResponse -.->|"User Actions"| UserInput
    Reports -.->|"Business Insights"| PricingEngine
    
    %% Background processes
    subgraph BackgroundProcesses ["Background Processes"]
        RecurringExpenses["ğŸ”„ Recurring Expenses<br/>Automated Creation"]
        TimerCleanup["ğŸ§¹ Timer Cleanup<br/>Orphaned Timers"]
        DataBackup["ğŸ’¾ Data Backup<br/>Scheduled Backups"]
    end
    
    RecurringExpenses --> ExpenseData
    TimerCleanup --> TimeData
    DataBackup --> DataStorage
    
    %% Styling
    classDef input fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef processing fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef storage fill:#e3f2fd,stroke:#0277bd,stroke-width:2px
    classDef output fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef external fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef background fill:#fff8e1,stroke:#f57c00,stroke-width:2px
    
    class UserInput,NDISData,FileUploads external
    class AuthValidation,InputValidation,FileProcessing input
    class UserMgmt,ClientMgmt,TimeMgmt,ExpenseMgmt,PricingEngine,InvoiceEngine,AuditEngine processing
    class UserData,ClientData,TimeData,ExpenseData,InvoiceData,PricingData,AuditData,FileData storage
    class ResponseFormatting,PDFGeneration,NotificationSvc,ReportGeneration output
    class APIResponse,GeneratedPDFs,Notifications,Reports external
    class RecurringExpenses,TimerCleanup,DataBackup background