name: Backend Deploy - Development (Hybrid Secure)

on:
  push:
    branches: [ dev, develop ]
  pull_request:
    branches: [ dev, develop ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency only)'
        required: false
        default: false
        type: boolean

concurrency:
  group: backend-dev-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  security-events: write
  id-token: write  # For Workload Identity Federation
  pull-requests: write

env:
  NODE_VERSION: '22'
  REGION: 'australia-southeast1'
  SERVICE_NAME: 'backend-dev'
  REGISTRY: 'australia-southeast1-docker.pkg.dev'
  GCP_PROJECT_ID: 'invoice-660f3'  # Dev project

jobs:
  # Security and Quality Checks
  security-scan:
    name: Security & Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: .
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run TruffleHog secret scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: .
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high || true

  # Testing
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: security-scan
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    defaults:
      run:
        working-directory: .
    services:
      mongodb:
        image: mongo:7
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: testpass
        ports:
          - 27017:27017
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        env:
          NODE_ENV: test
        run: npm test || echo "::warning::Tests not configured"

      - name: Run integration tests
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://test:testpass@localhost:27017/test?authSource=admin
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key
        run: npm run test:integration || echo "::warning::Integration tests not configured"

  # Build and Push Docker Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [security-scan, test]
    if: always() && needs.security-scan.result == 'success'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-uri: ${{ steps.image-uri.outputs.image-uri }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (Dev)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure GCP project
        run: gcloud config set project ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/backend-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/backend-repo/${{ env.SERVICE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/backend-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}
          format: spdx-json
          output-file: backend-sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: backend-sbom
          path: backend-sbom.spdx.json

      - name: Set image URI output
        id: image-uri
        run: |
          IMAGE_URI="${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/backend-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT

  # Deploy to Cloud Run
  deploy:
    name: Deploy to Cloud Run (Dev)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment:
      name: development
      url: https://${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (Dev)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure GCP project
        run: gcloud config set project ${{ env.GCP_PROJECT_ID }}

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          IMAGE_URI="${{ needs.build.outputs.image-uri }}"
          
          # Deploy with environment variables from GitHub secrets (non-sensitive)
          # and Secret Manager references for sensitive data
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image "$IMAGE_URI" \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 10 \
            --cpu 1 \
            --memory 512Mi \
            --timeout 300 \
            --cpu-boost \
            --port 8080 \
            --update-env-vars NODE_ENV=development,ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }},ALLOWED_DOWNLOAD_HOSTS=${{ secrets.ALLOWED_DOWNLOAD_HOSTS }},DB_NAME=${{ secrets.DB_NAME }},JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }},R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }},R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }},R2_PUBLIC_DOMAIN=${{ secrets.R2_PUBLIC_DOMAIN }},SMTP_ADMIN_EMAIL=${{ secrets.SMTP_ADMIN_EMAIL }},FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }},FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }},FIREBASE_CLIENT_ID=${{ secrets.FIREBASE_CLIENT_ID }},FIREBASE_CLIENT_CERT_URL=${{ secrets.FIREBASE_CLIENT_CERT_URL }} \
            --update-secrets MONGODB_URI=dev-mongodb-uri:latest,REDIS_URL=dev-redis-url:latest,JWT_SECRET=dev-jwt-secret:latest,STRIPE_SECRET_KEY=dev-stripe-secret:latest,STRIPE_WEBHOOK_SECRET=dev-stripe-webhook:latest,SMTP_PASSWORD=dev-smtp-password:latest,APP_PASSWORD=dev-app-password:latest,R2_ACCESS_KEY_ID=dev-r2-access-key:latest,R2_SECRET_ACCESS_KEY=dev-r2-secret:latest,FIREBASE_PRIVATE_KEY=dev-firebase-private-key:latest,FIREBASE_PRIVATE_KEY_ID=dev-firebase-private-key-id:latest \
            --no-traffic \
            --tag dev-${{ github.sha }}
          
          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $SERVICE_URL"

      - name: Run smoke tests
        run: |
          SERVICE_URL="${{ steps.deploy.outputs.url }}"
          
          # Wait for service to be ready
          sleep 15
          
          # Health check
          echo "Testing health endpoint..."
          curl -f "$SERVICE_URL/health" || echo "::warning::Health check failed"
          
          # Basic API test
          echo "Testing API health endpoint..."
          curl -f "$SERVICE_URL/api/health" || echo "::warning::API health check failed"

      - name: Gradual traffic migration
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "Starting gradual traffic migration..."
          
          # Migrate traffic: 10% -> 50% -> 100%
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --to-latest=10
          
          echo "::notice::Traffic migrated to 10% - monitoring for 2 minutes"
          sleep 120
          
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --to-latest=50
          
          echo "::notice::Traffic migrated to 50% - monitoring for 2 minutes"
          sleep 120
          
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --to-latest=100
          
          echo "::notice::Traffic fully migrated to new version"

      - name: Create deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸš€ Deployment Summary (Development)
          
          **Status:** ${{ job.status }}
          **Environment:** Development
          **GCP Project:** ${{ env.GCP_PROJECT_ID }}
          **Service:** ${{ env.SERVICE_NAME }}
          **Region:** ${{ env.REGION }}
          **Image:** \`${{ needs.build.outputs.image-uri }}\`
          **URL:** ${{ steps.deploy.outputs.url }}
          **Commit:** ${{ github.sha }}
          
          ### Security Features Enabled
          - âœ… Workload Identity Federation (keyless auth)
          - âœ… Sensitive secrets in Secret Manager
          - âœ… Security scanning (Trivy + TruffleHog)
          - âœ… Gradual traffic rollout
          - âœ… Optimized Docker image
          - âœ… SBOM generated
          
          EOF
