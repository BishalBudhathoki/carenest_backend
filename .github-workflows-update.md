# GitHub Actions Workflow Notes (Cloud Run + Consolidated Secrets)

This repo deploys a Node.js backend to **Google Cloud Run** using GitHub Actions.

## Consolidated secrets (current)

Instead of injecting many individual Secret Manager secrets into Cloud Run, the service receives:

- `CONSOLIDATED_SECRET_NAME` (e.g. `app-secrets-dev` / `app-secrets-prod`)
- `GCP_PROJECT_ID`

At runtime, the app loads the JSON secret from Secret Manager (via `config/secretLoader.js`) and populates `process.env`.

**Why**
- Fewer secrets to manage
- Lower Secret Manager overhead
- No need for CI to create or update secrets

## Development workflow behavior

The development Cloud Run service is **IAM-protected** (not public):

- Deployment uses `--no-allow-unauthenticated`.
- CI adds `roles/run.invoker` for the GitHub deployer service account.
- Smoke tests call a **tagged** revision URL and attach an **identity token**.

This prevents the Cloud Run URL from being publicly invokable while still letting CI validate the new revision.

## Production workflow behavior

- Production remains `--allow-unauthenticated` by default (intended for client apps).
- Production requires a manual approval gate before deployment.

## CodeQL Action v4

GitHubâ€™s CodeQL Action v3 is scheduled for deprecation in **December 2026**.
Workflows using `github/codeql-action/*@v3` should be updated to `@v4`.

## Common pitfalls (fixed in this repo)

- **Require-time env reads**: avoid reading `process.env.MONGODB_URI` at module load if secrets load later.
- **Startup crashes from optional integrations**: Firebase should not crash the container if not configured.
- **CI failures from gitignored runtime files**: tests expect `firebase-admin-config.js` to exist.

