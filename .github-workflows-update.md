# GitHub Actions Workflow Updates for Consolidated Secrets

## Overview

This document explains how to update your GitHub Actions workflows to use the new consolidated secrets approach. Instead of managing 10+ individual secrets in Google Cloud Secret Manager, you now use ONE secret per environment.

## What Changed

### Before (Old Approach)
- **11 individual secrets per environment** in Google Cloud Secret Manager
- Each secret accessed individually in Cloud Run deployment
- High cost ($0.03 per 10,000 accesses × 11 secrets)

### After (New Approach)  
- **1 consolidated secret per environment** containing all secrets as JSON
- Application loads the consolidated secret at startup
- Reduced cost (6 secrets free, only 2 secrets needed)

## Updated Deployment Configuration

### Development Environment (`backend-deploy-dev-hybrid.yml`)

**OLD deployment step (lines 259-269):**
```yaml
--update-secrets "MONGODB_URI=dev-mongodb-uri:latest" \
--update-secrets "REDIS_URL=dev-redis-url:latest" \
--update-secrets "JWT_SECRET=dev-jwt-secret:latest" \
--update-secrets "STRIPE_SECRET_KEY=dev-stripe-secret:latest" \
--update-secrets "STRIPE_WEBHOOK_SECRET=dev-stripe-webhook:latest" \
--update-secrets "SMTP_PASSWORD=dev-smtp-password:latest" \
--update-secrets "APP_PASSWORD=dev-app-password:latest" \
--update-secrets "R2_ACCESS_KEY_ID=dev-r2-access-key:latest" \
--update-secrets "R2_SECRET_ACCESS_KEY=dev-r2-secret:latest" \
--update-secrets "FIREBASE_PRIVATE_KEY=dev-firebase-private-key:latest" \
--update-secrets "FIREBASE_PRIVATE_KEY_ID=dev-firebase-private-key-id:latest" \
```

**NEW deployment step:**
```yaml
--update-secrets "APP_SECRETS=app-secrets-dev:latest" \
--set-env-vars "GCP_PROJECT_ID=invoice-660f3" \
```

### Production Environment (`backend-deploy-prod-hybrid.yml`)

**OLD deployment step (lines 285-295):**
```yaml
--update-secrets "MONGODB_URI=prod-mongodb-uri:latest" \
--update-secrets "REDIS_URL=prod-redis-url:latest" \
--update-secrets "JWT_SECRET=prod-jwt-secret:latest" \
--update-secrets "STRIPE_SECRET_KEY=prod-stripe-secret:latest" \
--update-secrets "STRIPE_WEBHOOK_SECRET=prod-stripe-webhook:latest" \
--update-secrets "SMTP_PASSWORD=prod-smtp-password:latest" \
--update-secrets "APP_PASSWORD=prod-app-password:latest" \
--update-secrets "R2_ACCESS_KEY_ID=prod-r2-access-key:latest" \
--update-secrets "R2_SECRET_ACCESS_KEY=prod-r2-secret:latest" \
--update-secrets "FIREBASE_PRIVATE_KEY=prod-firebase-private-key:latest" \
--update-secrets "FIREBASE_PRIVATE_KEY_ID=prod-firebase-private-key-id:latest" \
```

**NEW deployment step:**
```yaml
--update-secrets "APP_SECRETS=app-secrets-prod:latest" \
--set-env-vars "GCP_PROJECT_ID=carenest-prod" \
```

## Complete Updated Workflow Files

### Development Workflow Update

Replace lines 227-279 in `.github/workflows/backend-deploy-dev-hybrid.yml`:

```yaml
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          IMAGE_URI="${{ needs.build.outputs.image-uri }}"
          
          # Deploy with consolidated secrets from Secret Manager
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image "$IMAGE_URI" \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 10 \
            --cpu 1 \
            --memory 512Mi \
            --timeout 300 \
            --cpu-boost \
            --port 8080 \
            --set-env-vars "NODE_ENV=development" \
            --set-env-vars "GCP_PROJECT_ID=invoice-660f3" \
            --update-secrets "APP_SECRETS=app-secrets-dev:latest" \
            --no-traffic \
            --tag dev-${{ github.sha }}
          
          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $SERVICE_URL"
```

### Production Workflow Update

Replace lines 254-297 in `.github/workflows/backend-deploy-prod-hybrid.yml`:

```yaml
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          IMAGE_URI="${{ needs.build.outputs.image-uri }}"
          
          # Deploy with consolidated secrets from Secret Manager
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image "$IMAGE_URI" \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 1 \
            --max-instances 50 \
            --cpu 2 \
            --memory 1Gi \
            --timeout 300 \
            --cpu-boost \
            --port 8080 \
            --set-env-vars "NODE_ENV=production" \
            --set-env-vars "GCP_PROJECT_ID=carenest-prod" \
            --update-secrets "APP_SECRETS=app-secrets-prod:latest" \
            --no-traffic \
            --tag prod-${{ github.sha }}
          
          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $SERVICE_URL"
```

## Migration Steps

### 1. Upload Consolidated Secrets

First, upload your secrets from `secrets.json` to Google Cloud Secret Manager:

```bash
# From backend directory
npm run secrets:upload:dev   # Upload development secrets
npm run secrets:upload:prod  # Upload production secrets

# Or upload both at once
npm run secrets:upload:all
```

This creates:
- `app-secrets-dev` in project `invoice-660f3`
- `app-secrets-prod` in project `carenest-prod`

### 2. Grant Cloud Run Access

The upload script automatically grants access, but you can verify:

```bash
# Development
gcloud secrets add-iam-policy-binding app-secrets-dev \
  --member="serviceAccount:invoice-660f3@appspot.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor" \
  --project=invoice-660f3

# Production
gcloud secrets add-iam-policy-binding app-secrets-prod \
  --member="serviceAccount:carenest-prod@appspot.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor" \
  --project=carenest-prod
```

### 3. Update GitHub Actions Workflows

Apply the changes shown above to:
- `.github/workflows/backend-deploy-dev-hybrid.yml`
- `.github/workflows/backend-deploy-prod-hybrid.yml`

### 4. Install New Dependency

The `@google-cloud/secret-manager` package is already added to `package.json`. Install it:

```bash
npm install
```

### 5. Deploy and Test

```bash
# Push to dev branch to test
git add .
git commit -m "feat: migrate to consolidated secrets management"
git push origin dev

# Monitor the deployment
# Once successful, merge to main for production
```

### 6. Clean Up Old Secrets (Optional)

After verifying the new approach works, you can delete the old individual secrets:

```bash
# Development secrets
gcloud secrets delete dev-mongodb-uri --project=invoice-660f3
gcloud secrets delete dev-redis-url --project=invoice-660f3
gcloud secrets delete dev-jwt-secret --project=invoice-660f3
# ... etc

# Production secrets
gcloud secrets delete prod-mongodb-uri --project=carenest-prod
gcloud secrets delete prod-redis-url --project=carenest-prod
gcloud secrets delete prod-jwt-secret --project=carenest-prod
# ... etc
```

## Benefits

✅ **Cost Savings**: From 22 secrets (11 × 2 envs) → 2 secrets (free tier!)  
✅ **Easier Management**: One secret to update instead of 11  
✅ **Better Security**: Secrets stay in Secret Manager, not in GitHub  
✅ **Simplified Workflows**: Cleaner deployment scripts  
✅ **Version Control**: All secrets versioned together  

## Troubleshooting

### Application can't load secrets

**Check:**
1. Secret exists: `gcloud secrets describe app-secrets-dev --project=invoice-660f3`
2. Permissions granted: `gcloud secrets get-iam-policy app-secrets-dev --project=invoice-660f3`
3. Cloud Run has env var: `GCP_PROJECT_ID` must be set
4. Check logs: `gcloud logs read --limit 50 --project=invoice-660f3`

### Secrets upload fails

**Check:**
1. Authenticated: `gcloud auth list`
2. Correct project: `gcloud config get-value project`
3. secrets.json exists: `ls -la backend/secrets.json`
4. Valid JSON: `cat backend/secrets.json | jq .`

### Deployment fails

**Check:**
1. Secret Manager API enabled: `gcloud services enable secretmanager.googleapis.com`
2. Workflow has correct secret name: `app-secrets-dev` or `app-secrets-prod`
3. Image builds successfully before deployment step

## Secret Structure

The consolidated secret contains all environment variables as JSON:

```json
{
  "MONGODB_URI": "mongodb+srv://...",
  "REDIS_URL": "redis://...",
  "JWT_SECRET": "...",
  "STRIPE_SECRET_KEY": "sk_...",
  "FIREBASE_PRIVATE_KEY": "-----BEGIN PRIVATE KEY-----...",
  // ... all other secrets
}
```

The application loads this at startup and applies all values to `process.env`.

## Local Development

Local development continues to work with:
1. `.env` file (existing approach)
2. `secrets.json` file (new approach, automatically loaded)

No changes needed to local development workflow!
